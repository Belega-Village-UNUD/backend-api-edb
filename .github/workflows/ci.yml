name: Create and publish a API to Cloud Run

on:
  push:
    branches: ["staging"]

env:
  IMAGE_NAME: belega-commerce-api-image
  REPOSITORY: belega-commerce-api

jobs:
  ci-cd-api-docs:
    runs-on: ubuntu-latest
    environment: staging
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Google Auth
        id: auth
        uses: "google-github-actions/auth@v1"
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.CLOUD_RUN_SA }}
      - name: Docker configuration
        id: docker-config
        run: |-
          gcloud auth print-access-token \
            --impersonate-service-account ${{ secrets.CLOUD_RUN_SA }} | docker login \
            -u oauth2accesstoken \
            --password-stdin https://${{ secrets.REGION }}-docker.pkg.dev
      - name: Build
        run: |-
          docker build -f Dockerfile \
            --tag "${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:$GITHUB_SHA" \
            --build-arg GITHUB_SHA="$GITHUB_SHA" \
            --build-arg GITHUB_REF="$GITHUB_REF" \
            .
      - name: Tag Image with Latest
        run: |-
          docker tag "${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:$GITHUB_SHA" \
            "${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest"
      - name: Publish
        run: |-
          docker push "${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:$GITHUB_SHA"
          docker push "${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest"
      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v1
        with:
          service: ${{ secrets.SERVICE_NAME }}
          region: ${{ secrets.REGION }}
          image: ${{ secrets.REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest
          env_vars: |
            NODE_ENV=${{ secrets.NODE_ENV }}
            STAGING_DB_USERNAME=${{ secrets.STAGING_DB_USERNAME }}
            STAGING_DB_PASSWORD=${{ secrets.STAGING_DB_PASSWORD }}
            STAGING_DB_HOST=${{ secrets.STAGING_DB_HOST }}
            STAGING_DB_PORT=${{ secrets.STAGING_DB_PORT }}
            JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
            JWT_EXPIRES=${{ secrets.JWT_EXPIRES }}
            JWT_RESET_PASSWORD_KEY=${{ secrets.JWT_RESET_PASSWORD_KEY }}
            JWT_RESET_EXPIRES=${{ secrets.JWT_RESET_EXPIRES }}
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
            GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
            GOOGLE_REDIRECT_URI=${{ secrets.GOOGLE_REDIRECT_URI }}
            GOOGLE_REFRESH_TOKEN=${{ secrets.GOOGLE_REFRESH_TOKEN }}
            GOOGLE_EMAIL=${{ secrets.GOOGLE_EMAIL }}

      - name: Show Output
        run: |
          echo ${{ steps.deploy.outputs.url }}
          echo ${{ steps.deploy.image }}
